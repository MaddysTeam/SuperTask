@{
		Layout = "~/Views/Shared/_StudioLayout.cshtml";
		var pageTitle = ViewBag.Title = "计划任务列表";
		var defaultItem = new SelectListItem { Text = "全部", Value = TaskKeys.SelectAll.ToString() };
		var projectsSelectList = SelectListHelper.GetSelectItems(ViewBag.Projects as List<Project>, "ProjectName", "ProjectId", null, defaultItem);
		var resourceSelectList = SelectListHelper.GetSelectItems(ViewBag.Resources as List<Account>, "UserName", "UserId", null, defaultItem);
		var taskTypeList = new List<SelectListItem>
	{
		defaultItem,
		new SelectListItem { Text = "节点任务", Value = TaskKeys.NodeTaskType.ToString() },
		new SelectListItem { Text = "计划任务", Value = TaskKeys.PlanTaskTaskType.ToString() }
	};
}
@section Css{
	<link href="~/assets/plugins/jquery.searchableSelect/css/jquery.searchableSelect.css" rel="stylesheet" />
}

<div class="content-wrapper col-md-10">

	<div class="main-content">
		<!-- widget -->
		<div class="widget">
			<div class="widget-header">
				<h3>@pageTitle</h3>
				<div class="btn-group widget-header-toolbar">
					<a href="javascript:;" title="焦点" class="btn-borderless btn-focus"><i class="fa fa-eye"></i></a>
				</div>
			</div>

			<div class="widget-content">
				<div class="row" style="margin-bottom:20px;">

					<!-- 项目筛选下拉框 -->
					<div class="col-sm-4">
						<div class="form-horizontal">
							<div class="FormGroup">
								<label class="col-md-4 control-label">项目名称</label>
								<div class="col-md-7">
									@Html.DropDownList("Projects", projectsSelectList, new { @class = "form-control dropdown-myProjects" })
								</div>
							</div>
						</div>

					</div>

					<div class="col-sm-4">
						<div class="form-horizontal">
							<div class="FormGroup">
								<label class="col-md-4 control-label">任务类型</label>
								<div class="col-md-7">
									@Html.DropDownList("TaskType", taskTypeList, new { @class = "form-control dropdown-myProjects" })
								</div>
							</div>
						</div>
					</div>

	
					<!-- 项目经理筛选下拉框 -->
					<div class="col-sm-4">
						<div class="form-horizontal">
							<div class="FormGroup">
								<label class="col-md-4 control-label">任务负责人</label>
								<div class="col-md-7">
									@Html.DropDownList("Resources", resourceSelectList, new { @class = "form-control dropdown-resources" })
								</div>
							</div>
						</div>
					</div>

				</div>
				
				<div class="row">

					<!-- 开始时间下拉框 -->
					<div class="col-sm-4">
						<div class="form-horizontal">
							<label class="col-md-4 control-label">开始时间</label>
							<div class="col-md-7">

								<div class="input-group date" data-provide="datepicker" data-date-language="zh-CN" data-date-format="yyyy-mm-dd" data-date-autoclose="true">
									@Html.TextBox("Start", DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd"), new { @class = "form-control startDate" })
									<div class="input-group-addon"><i class="fa fa-calendar"></i></div>
								</div>

							</div>
						</div>
					</div>

					<!-- 结束时间下拉框 -->
					<div class="col-sm-4">
						<div class="form-horizontal">
							<label class="col-md-4 control-label">结束时间</label>
							<div class="col-md-7">
								<div class="input-group date" data-provide="datepicker" data-date-language="zh-CN" data-date-format="yyyy-mm-dd" data-date-autoclose="true">
									@Html.TextBox("End", DateTime.Now.AddDays(30).ToString("yyyy-MM-dd"), new { @class = "form-control plan endDate" })
									<div class="input-group-addon"><i class="fa fa-calendar"></i></div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Plan Task Grid -->
				<div class="table-responsive">
					<table id="bootgrid" class="table table-striped table-hover table-dark-header">
						<thead>
							<tr>
								<th data-column-id="project">所属项目</th>
								<th data-column-id="name">任务名称</th>
								<th data-column-id="manager">项目经理</th>
								<th data-column-id="taskType">任务类型</th>
								<th data-column-id="start" data-formatter="DateOnly">预估开始</th>
								<th data-column-id="end" data-formatter="DateOnly">预估结束</th>
								<th data-column-id="realEndString" >实际结束</th>
								<th data-column-id="status">任务状态</th>
								<th data-column-id="commands" data-formatter="commands" data-sortable="false" class="width160" data-header-Css-Class="width130">操作</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
			<!-- /widget content -->
		</div>
		<!-- /widget -->

	</div>
</div>
@section Plugins{
	<script src="~/assets/plugins/jquery.searchableSelect/js/jquery.searchableSelect.js"></script>
}
@section Modals{
	<button class="btn btn-md btn-custom-primary hidden" id="modelProxy" data-toggle="ajax-modal" data-target="#firstModal">代理</button>
	<!-- Modal start -->
	<div class="modal" id="firstModal" tabindex="-1" role="dialog" aria-labelledby="firstModalLabel" aria-hidden="true">
	</div>
	<!-- Modal end -->
}

@section Scripts {
	<script>

		function getGlobalRequest() {
			return {
				projectId: $('#Projects').val(),
				resourceId: $('#Resources').val(),
				start: $('#Start').val(),
				end: $('#End').val(),
				taskTypeId: $('#TaskType').val()
			};
		}

		function getGridOptions() {
			return $.extend(true, {}, gridOptions, {

				url: window.location.href,

				requestHandler: function (request) { return $.extend(true, request, getGlobalRequest()); },

				formatters: {
					'commands': function (column, row) {
						var id = row.id;
						var isMe = row.isMe;
						var reviewerIsMe = row.reviewerIsMe;
						var buttons = '<div class="btn-group btn-group-xs pull-right" data-row-id="' + id + '">';
						var isPlan = row.taskTypeId == '@TaskKeys.PlanTaskTaskType';

						var editUrl = isPlan ? '@Url.Action("PlanTaskEdit", "Task")' : '@Url.Action("Edit", "ProjectStoneTask")';  //post
						var startUrl = isPlan ? '@Url.Action("PlanTaskStart", "Task")' : '@Url.Action("Start", "ProjectStoneTask")'; //post
						var editReqeustUrl = isPlan ? '@Url.Action("ReviewRequest", "Task")?id=' + id + '&reviewType=@ReviewKeys.ReviewTypeForTkChanged' : //get
							                           '@Url.Action("ReviewRequest", "ProjectStoneTask")?id=' + id + '&reviewType=@ReviewKeys.ReviewTypeForStoneTaskChanged';  //get
						var submitReqeustUrl = isPlan ? '@Url.Action("ReviewRequest", "Task")?id=' + id + '&reviewType=@ReviewKeys.ReviewTypeForTkSubmit' :
							                           '@Url.Action("ReviewRequest", "ProjectStoneTask")?id=' + id + '&reviewType=@ReviewKeys.ReviewTypeForStoneTaskSubmit';  //get

						var denyUrl = isPlan ? '@Url.Action("PlanTaskDeny", "Task")?id=' + id  : '@Url.Action("Deny", "ProjectStoneTask")?id=' + id ; // post 
						var reviewUrl = '@Url.Action("Search", "WorkFlowTask")';

						if (isMe && row.statusId == '@TaskKeys.PlanStatus') {
							buttons += '<button class="btn btn-lg btn-danger btn-start" data-url="' + startUrl + '">启动</button>';
							buttons += '<button class="btn btn-lg btn-success btn-edit" data-url="' + editUrl + '">编辑</button>';
						}
						else if (isMe && row.statusId == '@TaskKeys.TaskTempEditStatus') {
							buttons += '<button class="btn btn-lg btn-success btn-edit"  data-url="' + editUrl + '">编辑</button>';
						}
						else if (isMe && row.statusId == '@TaskKeys.ProcessStatus') {
							buttons += '<button class="btn btn-lg btn-info btn-editReq"   data-url="' + editReqeustUrl + '">修改申请</button>';
							if (!row.isParent)
								buttons += '<button class="btn btn-lg btn-info btn-submitReq" data-url="' + submitReqeustUrl + '">提交申请</button>';
							else
								buttons += '<button class="btn btn-lg" disable>父任务无需提交</button>';
						}
						else if (reviewerIsMe && row.statusId == '@TaskKeys.ProcessStatus') {
							buttons += '<button class="btn btn-lg btn-info btn-deny" data-url="' + denyUrl + '">不合理退回</button>';
						}
						else if (reviewerIsMe && row.statusId == '@TaskKeys.ReviewStatus') {
							buttons += '<button class="btn btn-lg btn-success btn-view" disabled>审核中</button>';
							buttons += '<button class="btn btn-lg btn-info btn-review" data-url="' + reviewUrl + '">去审核</button>';
						}
						else if (!isMe) {
							buttons += '<button class="btn btn-lg btn-success btn-view" data-url="' + editUrl + '">查看详细</button>';
						}

						buttons += '</div>';

						return buttons;
					},
				},
			});
		}


		$(function () {

			$('#Projects,#Resources,#Start,#End,#TaskType').change(function () {
				$('#bootgrid').bootgrid('reload');
			});



			var grid = $('#bootgrid');
			grid.bootgrid(getGridOptions())
			.on('loaded.rs.jquery.bootgrid', function () {

				grid.find('.btn-edit,.btn-view').on('click', function (e) {
					var rowId = $(this).parent().data('rowId');
					var url = $(this).data('url');
					$('#modelProxy')
						   .data('url', url + '?id=' + rowId)
					      .trigger('click');
				});

				grid.find('.btn-start').on('click', function (e) {
					if (confirm('@Confirm.Task.TASK_CONFIRM_START')) {
						var rowId = $(this).parent().data('rowId');
						var url = $(this).data('url');
						$.post(url, { id: rowId }, function (data) {
							popupMessage(data, {
								success: function () {
									$('#bootgrid').bootgrid('reload');
								}
							});
						});
					}
				});

				grid.find('.btn-editReq').on('click', function (e) {
					var url = $(this).data('url');
					if (confirm('@Confirm.Task.TASK_SUBMIT_EDIT')) {
						window.open(url);
					}
					else
						return false;
				});

				grid.find('.btn-submitReq').on('click', function (e) {
					var url = $(this).data('url');
					if (confirm('@Confirm.Task.TASK_SUBMIT_REQUEST')) {
						window.open(url);
					}
					else
						return false;
				});

				grid.find('.btn-review').on('click', function (e) {
					var url = $(this).data('url');
					//var url = reviewUrl + '?taskId=' + rowId;

					window.open(url);
				});

				grid.find('.btn-deny').on('click', function (e) {
					var url = $(this).data('url');
					$.post(url, function (data) {
						popupMessage(data, {
							success: function () {
								$('#bootgrid').bootgrid('reload');
							}
						});
					});
				});

			});

		});
	</script>
}
