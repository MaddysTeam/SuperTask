@model Guid
@{
	var pageTitle = ViewBag.Title = "";
	Layout = "~/Views/Shared/_HomeLayout.cshtml";
	var userId = Model.ToString();
}
@section Css{
	<style>
	.taskArea{font-size:16px}
	.a{text-decoration:none}
	.left-side{}
	.right-side{}
	ul.statistic-list{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:flex-start;list-style:none}
	ul.statistic-list > li.statistic-item{margin:10px;cursor:pointer}
	ul.activity-list > li:hover{background:#eee}
	ul.activity-list > li .activity-icon{background:#FF6633;color:white;font-size:10px;font-weight:bold;font-family:Arial}
	ul.project-list{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:flex-start;list-style:none; overflow:auto}
	ul.project-list > li.project-name{border:1px solid #9999CE;font-size:18px;margin:10px;cursor:pointer}
	ul.project-list > li.project-name:hover{background:#9999CE;color:#fff}
	.widget.projects{margin:20px; max-height:400px; overflow:auto}
	</style>
	<link href="~/assets/plugins/jquery.searchableSelect/css/jquery.searchableSelect.css" rel="stylesheet" />

}

<link href="~/assets/plugins/jQuery.Gantt/test2/lib/jquery-ui-1.8.4.css" rel="stylesheet" />
<link href="~/assets/plugins/jQuery.Gantt/test2/jquery.ganttView.css" rel="stylesheet" />
<div class="content-wrapper">
	<!-- main -->
	<div class="content">
		<div class="main-content row">


			<!-- LEFT WIDGET TABBED CONTENT -->
			<div class="widget col-sm-3 left-side" style="margin:20px;padding:20px">

			</div>
			<!-- END LEFT WIDGET TABBED CONTENT -->
			<!-- RIGHT WIDGET TABBED CONTENT -->
			<div class="right-side col-sm-8">

				<div class="widget col-md-12 user-info" style="margin:20px;">

				</div>
				<div class="widget col-md-12 projects">
					<div class="text-center">
						<h2>参与的项目</h2>
					</div>
					<div class="project-list">
					</div>
				</div>
				<div class="widget col-md-12" style="margin:20px;">
					<div class="text-center">
						<h2>个人任务进度总览(最新20个)</h2>
					</div>
					<div style="margin-bottom:30px">
						<label >选择项目</label>
						<div class="dp-projects"></div>
					</div>
					<div id="ganttChart" ></div>
				</div>
				<div class="widget col-md-12" style="margin:20px;">
					<div class="text-center">
						<h2>个人项目工时统计</h2>
					</div>
					<div class="widget-content">
						<div class="col-md-12" id="taskChart" style="height:300px;"></div>
					</div>
				</div>

			</div>
			<!-- END RIGHT WIDGET TABBED CONTENT -->

		</div>
		<!-- /main-content -->
	</div>
	<!-- /main -->
</div>
@section Plugins{
	<script src="~/assets/plugins/jQuery.Gantt/test2/lib/date.js" charset="GB2312"></script>
	<script src="~/assets/plugins/jQuery.Gantt/test2/lib/jquery-ui-1.8.4.js" charset="GB2312"></script>
	<script src="~/assets/plugins/jQuery.Gantt/test2/jquery.ganttView.js" charset="GB2312"></script>
	<script src="~/assets/plugins/jQuery.Gantt/test2/example/data.js" charset="GB2312"></script>
	<script src="~/assets/js/echarts.min.js"></script>
	<script src="~/assets/plugins/jquery.searchableSelect/js/jquery.searchableSelect.js"></script>
}
@section Scripts{
	<script>

		$(function () {

			bindUserList(function () {
				// binding project dropdown list
				var loaded = false;
				$('#dpUsers').searchableSelect({
					afterSelectItem: function (v) {
						if (loaded) {
							bindData(v);
						}
						else {
							loaded = true;
						}
					}
				});

				// click event for project list in left side
				$('.user').click(function () {
					var $this = $(this);
					var id = $this.data('id');
					$('#dpUsers').val(id);
					// remove origin select plugin
					$('.searchable-select').remove();
					// rebuild searchable select plugin
					$('#dpUsers').searchableSelect({
						afterSelectItem: function (v) {
							bindData(v);
						}
					});

				});
			});

			bindData('@userId');

		});

		function bindData(userId) {
			//bind project info
			bindUserInfo(userId)
			//bind resource list
			bindjoinedProjectList(userId);
			//bind project dropdown list in gantte area
			bindJoinedProjectDropdownList(userId);
			//bind bar chart of workhours
			bindWorkhoursChart(userId)
		}


		function bindUserList(callback) {
			$.post('@Url.Action("UserList", "Home")', function (data) {
				$('.left-side').html(data);
				if (callback) {
					callback();
				}
			});
		}

		function bindjoinedProjectList(userId) {
			$.post('@Url.Action("JoinedProjectList", "Home")', { userId: userId }, function (data) {
				$('.project-list').html(data);
			});
		}

		function bindJoinedProjectDropdownList(userId) {
			$.post('@Url.Action("JoinedProjectDropdownList", "Home")', { userId: userId }, function (data) {
				$('.dp-projects')
					.html('')
					.append(data)
					.find('#dpProjects').searchableSelect({
					afterSelectItem: function (v) {
						bindGantte(userId,v);
					}
				});
			});
		}

		function bindUserInfo(userId) {
			$.post('@Url.Action("UserInfo", "Home")', { userId: userId }, function (data) {
				$('.user-info').html(data);
			});
		}

		function bindGantte(userId,projectId) {
			$.post('@Url.Action("UserTasksGantte", "Home")', { userId: userId,projectId:projectId, current: 0, rowCount: 20 }, function (data) {
				if (!data.rows || data.rows.length <= 0) {
					$("#ganttChart").html('');
					return false;
				}
				$("#ganttChart").html('').ganttView({
					data: data.rows,
					slideWidth: '100%',
					behavior: {
						onClick: function (data) {
							var msg = "You clicked on an event: { start: " + data.start.toString("M/d/yyyy") + ", end: " + data.end.toString("M/d/yyyy") + " }";
							$("#eventMessage").text(msg);
						},
						onResize: function (data) {
							var msg = "You resized an event: { start: " + data.start.toString("M/d/yyyy") + ", end: " + data.end.toString("M/d/yyyy") + " }";
							$("#eventMessage").text(msg);
						},
						onDrag: function (data) {
							var msg = "You dragged an event: { start: " + data.start.toString("M/d/yyyy") + ", end: " + data.end.toString("M/d/yyyy") + " }";
							$("#eventMessage").text(msg);
						}
					}
				});
			});
		}


		function bindWorkhoursChart(userId) {

			$.post("@Url.Action("PersonalWorkHours", "Home")", { userId: userId }, function (data) {
				var myChart = echarts.init(document.getElementById('taskChart'));
				option = {
					color: ['#3398DB'],
					tooltip: {
						trigger: 'axis',
						axisPointer: {            // 坐标轴指示器，坐标轴触发有效
							type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
						}
					},
					grid: {
						left: '3%',
						right: '4%',
						bottom: '3%',
						containLabel: true
					},
					xAxis: [
						{
							type: 'category',
							data: data.names,
							axisLabel: {
								interval: 0,//横轴信息全部显示
								rotate: -5,//-15度角倾斜显示
							},
						}
					],
					yAxis: [
						{
							type: 'value'
						}
					],
					series: [
						{
							name: '直接访问',
							type: 'bar',
							barWidth: '60%',
							data: data.values,
							itemStyle: {
								normal: {
									color: function (params) {
										var colorList = ["#3398db", "#434348", "#90ed7d", "#f7a35c", "#61a0a8", "#61a0a8", "#91c7ae"];
										return colorList[params.dataIndex]
									}
								}
							}
						}
					]
				};
				myChart.setOption(option);
				myChart.on('click', function (params) {
					location.href = "@Url.Action("UserManage","Home")";
				});
			});

		}

	</script>
}
