@{
	var pageTitle = ViewBag.Title = "我的任务";
	Layout = "~/Views/Shared/_Layout.cshtml";

	var projectId = Request["projectId"] ?? string.Empty;
	var requestTaskType = Request["TaskType"] ?? string.Empty;
	var requestTaskStatus = Request["TaskStatus"] ?? string.Empty;
	var requestTaskRange = Request["TaskRange"] ?? string.Empty;
	var statusList = DictionaryCache.Cached(TaskKeys.StatusGuid).GetSelectListById(requestTaskStatus.ToGuid(Guid.Empty), new SelectListItem { Text = "任务状态", Value = TaskKeys.SelectAll.ToString() }).ToList();
	var typeList = DictionaryCache.Cached(TaskKeys.TypeV2Guid).GetSelectListById(requestTaskType.ToGuid(Guid.Empty), new SelectListItem { Text = "任务类型", Value = TaskKeys.SelectAll.ToString() }).ToList();
	var levelList = DictionaryCache.Cached(TaskKeys.LevelGuid).GetSelectListById(requestTaskType.ToGuid(Guid.Empty), new SelectListItem { Text = "优先级", Value = TaskKeys.SelectAll.ToString() }).ToList();
	var projectsSelectList = SelectListHelper.GetSelectItems(ViewBag.Projects as List<Project>, "ProjectName", "ProjectId", v => v.ToString() == projectId, new SelectListItem { Text = "所有项目", Value = TaskKeys.SelectAll.ToString() });
	var isBoss = Html.GetUserProfile().IsBoss;
}
@section Css{
	<link href="~/assets/plugins/jquery.searchableSelect/css/jquery.searchableSelect.css" rel="stylesheet" />
	<style>
		.searchable-select {
			min-width: 100px;
		}

		.left-side {
			border: 1px solid #ddd;
			overflow-y: auto;
			height: 800px;
		}

		.right-side {
			margin-left: 10px;
		}

			.right-side > .btn-group {
				position: absolute;
				top: 20px;
				z-index: 99;
			}

		.top-side {
			margin-bottom: 20px;
			margin-top: 5px;
		}

			.top-side .search-area {
				margin-left: 2%;
				padding: 5px;
			}

		.bottom-side {
			margin-top: -20px;
		}
	</style>
}

<div class="content-wrapper">

	<!-- main -->
	<div class="content">
		<div class="row top-side">

			<!-- 项目筛选下拉框 -->
			<div class="col-md-2">
				<div class="form-horizontal">
					<div class="FormGroup">
						@Html.DropDownList("dpProjects", projectsSelectList, new { @class = "form-control dropdown-myProjects" })
					</div>
				</div>
			</div>
			<!-- /任务搜索框 -->

			<div class="col-md-9 row search-area">

				<div class="col-md-1">
					<div class="form-horizontal">
						<div class="FormGroup">
							<a id="showAll" class="btn btn-info">所有</a>
						</div>
					</div>
				</div>
				<div class="col-sm-2">
					<div class="form-horizontal">
						<div class="FormGroup">
							@Html.DropDownList("dpLevels", levelList, new { @class = "form-control dropdown-taskLevels", })
						</div>
					</div>
				</div>
				<div class="col-md-2">
					<div class="form-horizontal">
						<div class="FormGroup">
							@Html.DropDownList("dpStatus", statusList, new { @class = "form-control dropdown-taskStatus", })
						</div>
					</div>
				</div>
				<div class="col-sm-2">
					<div class="form-horizontal">
						<div class="FormGroup">
							@Html.DropDownList("dpTypes", typeList, new { @class = "form-control dropdown-taskTypes", })
						</div>
					</div>
				</div>


				<div class="col-sm-2">
					<div class="form-horizontal">
						<div class="FormGroup" style="float:left">
							<input type="text" placeholder="输入任务名称" class="form-control txt-taskName " id="txtName" />
						</div>
					</div>
				</div>

				<div class="col-sm-1">
					<a class="btn btn-info" id="btnSearch">搜索</a>
				</div>

				<div class="text-left">
					<div class="form-horizontal">
						<div class="FormGroup">
							<a href="#" id="manage" class="">我负责的</a>
							<a href="#" id="assign" class="">指派给我</a>
							<a href="#" id="create" class="">我新建的</a>
							<input type="hidden" id="hidAssgin" value="false" />
							<input type="hidden" id="hidManage" value="false" />
							<input type="hidden" id="hidCreate" value="false" />
						</div>
					</div>
				</div>
				<!-- /搜索按钮 -->
			</div>


		</div>

		<div class="row bottom-side">
			<div class="col-md-2 left-side">
				<h3>参与的项目</h3>
				<hr />
				@Html.Partial("_projectList", ViewBag.Projects as List<Project>)
			</div>
			<div class="row col-md-10 right-side">
				<div class="btn-group">
					<a class="btn btn-danger" data-toggle="ajax-modal" data-url="@Url.Action("Add", "TaskV2")" data-target="#firstModal"><i class="fa fa-plus-square"></i>创建任务</a>
					<a class="btn btn-success" id="start" data-url="@Url.Action("MultipleComplete","TaskV2")">完成</a>
					<a class="btn btn-warning" id="close" data-url="@Url.Action("MultipleClose","TaskV2")">关闭</a>
				</div>
				<div class="table-responsive">
					<table id="bootgrid" class="table table-striped table-hover table-dark-header">
						<thead>
							<tr>
								<th data-column-id="SortId">ID</th>
								<th data-column-id="V2LevelTitle">优先级</th>
								<th data-column-id="TaskName" data-formatter="TaskName">任务名称</th>
								<th data-column-id="Status">状态</th>
								<th data-column-id="TypeV2">类型</th>
								<th data-column-id="Manager">负责人</th>
								<th data-column-id="Executor">指派给</th>
								<th data-column-id="WorkHours">已消耗(累计)</th>
								<th data-column-id="EstimateWorkHours">预计消耗</th>
								<th data-column-id="EndDate" data-formatter="DateOnly">预计完成</th>
								<th data-column-id="commands" data-formatter="commands" data-sortable="false" class="width160" data-header-Css-Class="width130">操作</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>

		</div>

	</div>
	<!-- /main -->

</div>


@section Plugins{
	<script src="~/assets/plugins/jquery.searchableSelect/js/jquery.searchableSelect.js"></script>
}
@section Modals{
	<button class="btn btn-md btn-custom-primary hidden" id="modelProxy" data-toggle="ajax-modal" data-target="#firstModal">代理</button>
	<!-- Modal start -->
	<div class="modal fade" id="firstModal" tabindex="-1" role="dialog" aria-labelledby="firstModalLabel" aria-hidden="true">
	</div>
	<!-- Modal end -->
}
@section Scripts{
	<script>
		function getGlobalRequest() {
			return {
				projectId: $('#dpProjects').val(),
				levelId: $('#dpLevels').val(),
				typeId: $('#dpTypes').val(),
				statusId: $('#dpStatus').val(),
				isAssign: $('#hidAssgin').val(),
				isManage: $('#hidManage').val(),
				isCreate: $('#hidCreate').val(),
				taskName: $('#txtName').val(),
			};
		}

		function isPlan(status) {
			return status == '@TaskKeys.PlanStatus';
		}

		function isNotComplete(status) {
			return status != '@TaskKeys.CompleteStatus' && status != '@TaskKeys.CloseStatus';
		}

		function isNotClose(status) {
			return status != '@TaskKeys.CloseStatus';
		}

		function getGridOptions() {
			return $.extend(true, {}, gridOptions, {

				url: window.location.href,

				requestHandler: function (request) { return $.extend(true, request, getGlobalRequest()); },

				formatters: {
					'TaskName': function (column, row) {
						var url = '@Url.Action("Detail", "TaskV2")?id=' + row.TaskId;

						var link = '<a href="' + url + '">' + row.TaskName + '</a>'
						if (row.IsParent)
							link += '&nbsp;&nbsp;<span class="text-align:right isParnet"><i class="fa fa-minus-square-o btn-hide-child" style="cursor:pointer"></i><i class="fa fa-plus-square-o btn-show-child" style="cursor:pointer"></i>'
						return link;
					},
					'commands': function (column, row) {
						var currentUserId = '@Html.GetUserProfile().UserId';
						var isManager = currentUserId === row.ManagerId;
						var isExecutor = currentUserId === row.DefaultExecutorId;
						var parentId = row.ParentId;
						var id = row.TaskId;
						var isParent = row.IsParent;
						var status = row.TaskStatus;
						var projectId = row.Projectid;

						if (!isManager && !isExecutor)
							return '<div class="btn-group btn-group-xs pull-right rowId" data-name="' + row.taskName + '" data-row-id="' + id + '" data-pid="' + parentId + '" data-row-active="' + row.actived + '"></div>	'

						var subTaskButtonStr = isParent && isNotComplete(status) && isNotClose(status) ? '<button data-url="@Url.Action("AddSubTask", "TaskV2")?projectId=' + projectId + '&parentId=' + id + '" class="btn btn-lg btn-info btn-subTasks">子任务</button> ' : '<button class="btn" disable="disable">子任务</button>';
						var editTaskButtonStr = isManager ? '<a target="_blank" href="@Url.Action("Edit", "TaskV2")?id=' + id + '" class="btn btn-lg btn-info btn-close">编辑</a>' : '';
						var completeButtonStr = isNotComplete(status) ? '<a data-url="@Url.Action("Complete", "TaskV2")?id=' + id + '" class="btn btn-lg btn-success btn-complete">完成</a> ' : '<button class="btn" disable="disable">已完成</button>';
						var journalButtonStr = isExecutor && isNotComplete(status) ? '<a  data-url="@Url.Action("JournalEdit", "TaskV2")?id=' + id + '" class="btn btn-lg btn-info btn-journal">工时</a> ' : '';
						var restartButtonStr = isManager && !isNotComplete(status) ? '<a data-url="@Url.Action("Start", "TaskV2")?id=' + id + '" class="btn btn-lg btn-warning btn-start">退回</a> ' : '';

						return '<div class="btn-group btn-group-xs pull-right rowId" data-name="' + row.taskName + '" data-row-id="' + id + '" data-pid="' + parentId + '" data-row-active="' + row.actived + '">' +
							restartButtonStr +
							completeButtonStr +
							editTaskButtonStr +
							journalButtonStr +
							subTaskButtonStr +
								'</div>';
					},
				},
			});
		}

		$(function () {

			isLoaded = false;
			let isBoss = '@isBoss' == 'False' ? false : true;

			$('#showAll').click(function () {
				$('#checkAll').attr("checked", false);
				$('#dpLevels,#dpStatus,#dpTypes').val('@TaskKeys.SelectAll');
				$('#txtName,#searchPhrase').val('');
				$('#hidManage,#hidAssgin,#hidCreate').val('false');
				$('#bootgrid').bootgrid('reload');
			});

			$('#assign').click(function () {
				$('#checkAll').attr("checked", false);
				$('#hidAssgin').val('true');
				$('#hidManage,#hidCreate').val('false');
				$('#bootgrid').bootgrid('reload');
			});

			$('#manage').click(function () {
				$('#checkAll').attr("checked", false);
				$('#hidManage').val('true');
				$('#hidAssgin,#hidCreate').val('false');
				$('#bootgrid').bootgrid('reload');
			});


			$('#create').click(function () {
				$('#checkAll').attr("checked", false);
				$('#hidCreate').val('true');
				$('#hidAssgin,#hidManage').val('false');
				$('#bootgrid').bootgrid('reload');
			});

			$('#btnSearch').click(function () {
				$('#checkAll').attr("checked", false);
				$('#bootgrid').bootgrid('reload');
			});

			$('#dpProjects').searchableSelect({
				afterSelectItem: function (v) {
					if (isLoaded) {
						$('#bootgrid').bootgrid('reload');
					}
				}
			});

			$('#dpLevels,#dpStatus,#dpTypes').change(function () {
				$('#bootgrid').bootgrid('reload');
			});

			// click event for project list in left side
			$('.project').click(function () {
				var $this = $(this);
				var id = $this.data('id');
				$('#dpProjects').val(id);

				// remove origin select plugin
				$('.searchable-select').remove();
				// rebuild searchable select plugin
				$('#dpProjects').searchableSelect({
					afterSelectItem: function (v) {
						$('#bootgrid').bootgrid('reload');
					}
				});
			});

			var grid = $('#bootgrid');
			grid.bootgrid(getGridOptions())
				.on('loaded.rs.jquery.bootgrid', function () {

					$('.search').hide();  // hide search box
					//$('.btn-hide-child').click(); // hide child task

					isLoaded = true;

					grid.find('.btn-subTasks,.btn-journal,.btn-complete,.btn-start').on('click', function (e) {
						var url = $(this).data('url');
						var $proxy = $('#modelProxy');
						$proxy
							.data('url', url)
							.trigger('click');
					});


					grid.find('.btn-hide-child').click(function () {
						let $this = $(this);
						var parentId = $this.parents('tr').find('.rowId').data('rowId');
						$(this).hide()
							    .parent()
							    .find('.btn-show-child').show();
						let siblings = $this.parents('tr').next();
						while (siblings.children().length > 0) {
							var pid = siblings.find('.rowId').data('pid');
							if (siblings.find('.isParnet').length > 0 || pid != parentId)
								break;
							else {
								siblings.hide();
							}
							siblings = siblings.next();
						}
					});

					grid.find('.btn-show-child').hide().click(function () {
						let $this = $(this);
						var parentId = $this.parents('tr').find('.rowId').data('rowId');
						$(this).hide()
							    .parent()
							    .find('.btn-hide-child').show();
						var siblings = $this.parents('tr').next();
						while (siblings.children().length > 0) {
							var pid = siblings.find('.rowId').data('pid');
							if (siblings.find('.isParnet').length > 0 || pid != parentId)
								break;
							else {
								siblings.show();
							}
							siblings = siblings.next();
						}
					});

					if (isBoss)
						grid.find('.btn-hide-child').trigger('click');

					initTableCheckbox('bootgrid')

					// multiple start,complete and close tasks
					$('#start,#complete,#close').off('click').on('click', function () {
						result = [];
						grid.find('.checkItem').each(function (i) {
							$this = $(this);
							if ($this.is(':checked')) {
								var rowId = $this.parent().parent().find('.rowId').data('rowId');
								result.push(rowId);
							}
						});

						if (result.length > 0) {
							var projectId = $('#dpProjects').val();
							ids = result.join(',');
							var url = $(this).data('url') + '?ids=' + ids + '&projectId=' + projectId;
							var $proxy = $('#modelProxy');
							$proxy.data('url', url).trigger('click')
						}
						else {
							alert('请先勾选任务！')
						}
					});

				});



		});

	</script>
}