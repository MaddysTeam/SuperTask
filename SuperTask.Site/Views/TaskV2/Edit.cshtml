@model WorkTask
@{
	var subTasks = ViewBag.SubTask as List<WorkTask>;
	var attahcments = ViewBag.Attahcments as List<Attachment>;
	var isCompeleteOrClose = Model.IsCompleteStatus || Model.IsCloseStatus;
}
<link href="~/assets/plugins/select2-4.0.2/css/select2.min.css" rel="stylesheet" />
<style>
	.dropzonePop {
		display: none;
	}
</style>


<div class="row" style="margin-top:20px;margin-bottom:20px;">
	<a class="btn btn-lg btn-danger col-md-1 col-md-offset-1" href="@Url.Action("List","TaskV2")">返回</a>
	<div class="col-md-6">
		<h4>@Model.SortId - @Model.V2LevelTitle - @Model.ProjectName - @Model.TaskName</h4>
	</div>
</div>
<div class="row">

	<!-- widget -->
	<div class="widget details col-md-7 col-md-offset-1">

		<form action="@Url.Action("UploadFile", "Attachment")" class="dropzone file"></form>

		<form id="taskForm" class="form-horizontal" action="@Url.Action("Edit","TaskV2")" role="form" data-after-success="afterDialogSuccess()" style="">

			<div class="widget-content">

				<div class="row editTaskInfo">
					<fieldset class="col-sm-12">
						@Html.HiddenFor(t => t.Projectid)
						@Html.HiddenFor(t => t.SortId)
						@Html.HiddenFor(t => t.TaskId)
						@Html.HiddenFor(t => t.ParentId)
						@Html.HiddenFor(t => t.IsParent)
						@Html.HiddenFor(t => t.WorkHours)
						@Html.HiddenFor(t => t.RelativeRequireIds)
						@Html.HiddenFor(t => t.RelativeBugIds)
						@Html.HiddenFor(t => t.RelativePublishIds)

						<div class="form-group">
							@Html.LabelFor(t => t.TaskName, new { @class = "control-label col-md-2" })
							<div class="col-md-9">
								@Html.TextBoxFor(t => t.TaskName, new { @class = "form-control" })
								@Html.ValidationMessageFor(t => t.TaskName)
							</div>
						</div>

						<div class="form-group">
							@Html.LabelFor(t => t.ProjectName, new { @class = "control-label col-md-2" })
							<div class="col-md-9">
								<span class="form-control details-text" style="background-color:#eee;">@Model.ProjectName</span>
							</div>
						</div>

						<div class="form-group">
							@Html.LabelFor(t => t.TaskStatus, new { @class = "control-label col-md-2" })
							<div class="col-md-2">
								@Html.DropDownListFor(t => t.TaskStatus,
									DictionaryCache.Cached(TaskKeys.StatusGuid)
														.GetSelectListById(Guid.Empty),
									new { @class = "form-control dropdown-taskStatus" })
							</div>
						</div>

						<div class="form-group">
							@Html.LabelFor(t => t.TaskType, new { @class = "control-label col-md-2" })
							<div class="col-md-2">
								@Html.DropDownListFor(t => t.TaskType,
									DictionaryCache.Cached(TaskKeys.TypeGuid)
														.GetSelectListById(Guid.Empty),
									new { @class = "form-control dropdown-taskType" })
							</div>
							@Html.LabelFor(t => t.TaskLevel, new { @class = "control-label col-md-2	" })
							<div class="col-md-2">
								@Html.DropDownListFor(t => t.V2Level,
									DictionaryCache.Cached(TaskKeys.LevelGuid)
														.GetSelectListById(Guid.Empty),
									new { @class = "form-control dropdown-taskLevel" })
							</div>
						</div>

						<div class="form-group">
							@Html.LabelFor(t => t.Manager, new { @class = "control-label col-md-2 text-align:left" })
							<div class="col-md-2">
								@Html.DropDownListFor(t => t.ManagerId,
									SelectListHelper.GetSelectItems(ViewBag.Users as List<UserInfo>, "UserName", "UserId"),
									new { @class = "form-control dropdown-project2" })
							</div>

							@Html.LabelFor(t => t.EstimateWorkHours, new { @class = "control-label col-md-2 text-align:left" })
							<div class="col-md-2">
								@Html.TextBoxFor(t => t.EstimateWorkHours, new { @class = "form-control" })
							</div>
							@Html.Label("实际消耗", new { @class = "control-label col-md-2 text-align:left" })
							<div class="col-md-1">
								@Html.Label("WorkHours", Model.WorkHours.ToString(), new { @class = "form-control " })
							</div>
							@if (!isCompeleteOrClose)
							{
								@*<div>
										<a id="btnEditJournal" data-toggle="ajax-modal" data-url="@Url.Action("JournalEdit", "TaskV2", new { id = Model.TaskId })" data-target="#firstModal" class="btn btn-info"><i class="fa fa-clock-o"> </i></a>
									</div>*@
							}
						</div>
						@if (Model.IsParent)
						{
							<div class="form-group subTaskExecutor">
								<div class="col-md-2 col-md-offset-2">
									<a href="#" class="btn btn-info" onclick="addSubTaskExecutor()">新增执行人<i class="fa fa-plus"> </i></a>
								</div>
							</div>
						}
						@foreach (var item in ViewBag.SubTask as List<WorkTask>)
						{
							<div class="form-group subTaskExecutor" data-task-id="@item.TaskId">
								@Html.Label("执行人", new { @class = "control-label col-md-2 text-align:left" })
								<div class="col-md-2">
									@Html.DropDownList("ExecutorId",
									SelectListHelper.GetSelectItems(ViewBag.Users as List<UserInfo>, "UserName", "UserId", v => v.ToString() == item.ManagerId.ToString()),
									new { @class = "form-control" })
								</div>

								@Html.Label("预计消耗", new { @class = "control-label col-md-2 text-align:left" })
								<div class="col-md-2">
									@Html.TextBox("EstimateWorkHours", item.EstimateWorkHours, new { @class = "form-control" })
								</div>

								@Html.Label("实际消耗", new { @class = "control-label col-md-2 text-align:left" })
								<div class="col-md-1">
									@Html.Label("WorkHours", item.WorkHours.ToString(), new { @class = "form-control " })
								</div>
								<div>
									<a href="#" class="btn btn-info" onclick="removeSubTaskExecutor(this)"><i class="fa fa-minus"> </i></a>
								</div>
								@Html.Hidden("SubTaskId", item.TaskId)
							</div>
						}

						<div class="form-group">
							@Html.LabelFor(t => t.Description, new { @class = "control-label col-md-2" })
							<div class="col-md-9">
								@Html.TextAreaFor(t => t.Description, 12, 2, new { @class = "form-control" })
								@Html.ValidationMessageFor(t => t.Description)
							</div>
						</div>

						<div class="form-group">
							@Html.HiddenFor(t => t.CurrentAttachment.RealName, new { @class = "fileName" })
							@Html.HiddenFor(t => t.CurrentAttachment.Url, new { @class = "filePath" })
							<label class="col-md-2 control-label">上传文件</label>
							<div class="col-md-5">
								<input style="visibility:hidden;position:absolute;" />
								<div class="input-group">
									<label id="uploadName" class="form-control oversize uploadName"></label>
									<span class="input-group-btn">
										<button class="btn btn-danger" type="button" id="btn-upload">附件上传</button>
									</span>
								</div>
							</div>
						</div>

						<div class="form-group">
							@Html.Label("关联需求", new { @class = "control-label  col-md-2" })
							<div class="col-md-2">
								<select id="requires" class="form-control new-select" multiple="multiple"></select>
							</div>

							@Html.Label("关联bug", new { @class = "control-label col-md-2" })
							<div class="col-md-2">
								<select id="bugs" class="form-control new-select" multiple="multiple"></select>
							</div>

							@Html.Label("关联发布", new { @class = "control-label col-md-2 text-left" })
							<div class="col-md-2">
								<select id="publishs" class="form-control new-select" multiple="multiple"></select>
							</div>
						</div>

						<div class="form-group">
							@Html.Label("预估开始结束时间", new { @class = "control-label col-md-2" })
							<div class="col-md-3">
								<div class="input-group date" data-provide="datepicker" data-date-language="zh-CN" data-date-format="yyyy-mm-dd" data-date-autoclose="true">
									@Html.TextBoxFor(t => t.StartDate, "{0:yyyy-MM-dd}", new { @class = "form-control startDate" })
									<div class="input-group-addon"><i class="fa fa-calendar"></i></div>
								</div>
							</div>

							<div class="col-md-3">
								<div class="input-group date" data-provide="datepicker" data-date-language="zh-CN" data-date-format="yyyy-mm-dd" data-date-autoclose="true">
									@Html.TextBoxFor(t => t.EndDate, "{0:yyyy-MM-dd}", new { @class = "form-control endDate" })
									<div class="input-group-addon"><i class="fa fa-calendar"></i></div>
								</div>
							</div>
						</div>

						<div class="form-group">
							@Html.Label("实际开始结束时间", new { @class = "control-label col-md-2" })
							<div class="col-md-3">
								<span class="form-control details-text" style="background-color:#eee;">@(Model.RealEndDate <= DateTime.MinValue ? " " : Model.RealStartDate.ToString("yyyy-MM-dd")) </span>
							</div>
							<div class="col-md-3">
								<span class="form-control details-text" style="background-color:#eee;">@(Model.RealEndDate <= DateTime.MinValue ? " " : Model.RealEndDate.ToString("yyyy-MM-dd"))</span>
							</div>
						</div>

						<div class="input-group center-block">
							<button class="btn btn-info col-md-3 col-md-offset-2 btn-custom-primary">保存</button>
							<a class="btn btn-info col-md-3" href="@Url.Action("List","TaskV2")">取消</a>
						</div>

					</fieldset>

				</div>

			</div>

		</form>

	</div>

	@Html.Partial("_subTaskList")

</div>
@section Modals{
	<button class="btn btn-md btn-custom-primary hidden" id="modelProxy" data-toggle="ajax-modal" data-target="#firstModal">代理</button>
	<!-- Modal start -->
	<div class="modal fade" id="firstModal" tabindex="-1" role="dialog" aria-labelledby="firstModalLabel" aria-hidden="true">
	</div>
	<!-- Modal end -->
}
@section Scripts{

	<script src="~/assets/plugins/ckeditor_4.14.1_standard/ckeditor/ckeditor.js"></script>
	<script src="~/assets/plugins/select2-4.0.2/js/select2.min.js"></script>
	<script>

		$(function () {

			//submit form by ajax
			ajaxSubmitForm($('#taskForm'), true);

			//initial ckeditor
			var myEditor = initCKEditor('Description');
			$('#submit').click(function () {
				$('#RelativeRequireIds').val($('#requires').val());
				$('#RelativeBugIds').val($('#bugs').val());
				$('#RelativePublishIds').val($('#publishs').val());
				$('#Description').val(myEditor.getData());
			});

			//fix bug
			$('#btnEditJournal').click();

			// init drop zone
			initDropZone();

			// load relative items
			var projectId = '@Model.Projectid';
			bindRequiresDropDown(projectId);
			bindBugsDropDown(projectId);
			bindPublishsDropDown(projectId);

		});


		function addSubTaskExecutor() {
			$.post('@Url.Action("AddExecutor", "TaskV2")', function (html) {
				$('.subTaskExecutor:last').after(html);
			})
		}

		function removeSubTaskExecutor(obj) {
			var taskId = $(obj).parents('.subTaskExecutor').data('taskId');
			if (taskId) {
				$.post('@Url.Action("Delete", "TaskV2")', { id: taskId }, function () {
					$(obj).parent().parent().remove();
				})
			}
			else {
				$(obj).parent().parent().remove();
			}
		}

		function afterDialogSuccess() {
			$('#childTaskgrid').bootgrid('reload');
		}

		function bindRequiresDropDown(projectId) {
			// remove previous select value
			$('#requires').children().remove();
			// post data for tasks from service side
			$.post('@Url.Action("GetProjectRequires", "Require")', { projectId: projectId }, function (data) {
				if (data.rows) {
					var selectRequireIds = '@Model.RelativeRequireIds'.split(',');
					$('#requires').select2({
						data: data.rows,
						placeholder: "请选择"
					}).val(selectRequireIds).trigger('change'); // bind relative task data
				}
			});
		}

		function bindBugsDropDown(projectId) {
			// remove previous select value
			$('#bugs').children().remove();
			// post data for tasks from service side
			$.post('@Url.Action("GetProjectBugs", "Bug")', { projectId: projectId }, function (data) {
				if (data.rows) {
					$('#bugs').select2({
						data: data.rows,
						placeholder: "请选择"
					}).trigger('change'); // bind relative bug data
				}
			});
		}

		function bindPublishsDropDown(projectId) {
			// remove previous select value
			$('#publishs').children().remove();
			// post data for tasks from service side
			$.post('@Url.Action("GetProjectPublishs", "Publish")', { projectId: projectId }, function (data) {
				if (data.rows) {
					$('#publishs').select2({
						data: data.rows,
						placeholder: "请选择"
					}).trigger('change'); // bind relative bug data
				}
			});
		}	

	</script>
}